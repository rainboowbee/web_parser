# Интеграция Prisma в Telegram Mini App

## Что было добавлено

### 1. **Модель пользователя (User)**
- **Данные от Telegram:**
  - `telegramId` - уникальный ID пользователя в Telegram
  - `firstName`, `lastName` - имя и фамилия
  - `username` - username в Telegram
  - `languageCode` - код языка пользователя
  - `isPremium` - премиум статус
  - `addedToAttachmentMenu` - добавлен в меню вложений
  - `allowsWriteToPm` - разрешает писать в личные сообщения
  - `photoUrl` - URL аватара

- **Данные приложения:**
  - `role` - роль пользователя (USER/ADMIN)
  - `isActive` - активен ли пользователь
  - `lastSeen` - последний визит
  - `createdAt`, `updatedAt` - даты создания и обновления

### 2. **Сервисы и API**
- `UserService` - сервис для работы с пользователями
- API endpoints:
  - `POST /api/users/sync` - синхронизация с Telegram
  - `GET /api/users` - получение всех пользователей
  - `GET /api/users/[id]` - получение пользователя по ID
  - `PATCH /api/users/[id]` - обновление роли

### 3. **React компоненты**
- `useUser` - хук для работы с пользователем
- `UserProfile` - компонент профиля пользователя
- `UsersList` - список пользователей (для админов)
- `AdminGuard` - защита админ-функций

### 4. **Валидация и безопасность**
- Валидация данных от Telegram
- Нормализация данных
- Проверка прав доступа

## Структура файлов

```
src/
├── lib/
│   └── prisma.ts              # Prisma клиент
├── types/
│   └── user.ts                # Типы пользователя
├── services/
│   └── userService.ts         # Сервис пользователей
├── hooks/
│   └── useUser.ts             # Хук для работы с пользователем
├── components/
│   ├── UserProfile/
│   │   └── UserProfile.tsx    # Компонент профиля
│   ├── UsersList/
│   │   └── UsersList.tsx      # Список пользователей
│   └── AdminGuard/
│       └── AdminGuard.tsx     # Защита админ-функций
├── utils/
│   └── telegramValidation.ts  # Валидация данных Telegram
└── app/
    ├── api/users/
    │   ├── route.ts           # API всех пользователей
    │   └── sync/route.ts      # API синхронизации
    ├── api/users/[id]/
    │   └── route.ts           # API конкретного пользователя
    ├── profile/
    │   └── page.tsx           # Страница профиля
    └── admin/users/
        └── page.tsx           # Админ-панель пользователей

prisma/
└── schema.prisma              # Схема базы данных
```

## Как это работает

### 1. **При входе пользователя:**
1. Telegram передает данные пользователя через `initData.user`
2. Хук `useUser` автоматически синхронизирует данные с базой
3. Пользователь создается или обновляется в базе данных

### 2. **Роли пользователей:**
- **USER** - обычный пользователь (по умолчанию)
- **ADMIN** - администратор (может управлять пользователями)

### 3. **Безопасность:**
- Все админ-функции защищены компонентом `AdminGuard`
- Валидация всех данных от Telegram
- Проверка прав доступа на уровне API

## Следующие шаги

1. **Настройка базы данных:**
   ```bash
   # Создайте файл .env с DATABASE_URL
   npm run db:generate
   npm run db:push
   ```

2. **Добавление дополнительных моделей:**
   - Модель для чатов
   - Модель для сообщений
   - Модель для настроек

3. **Расширение функционала:**
   - Статистика пользователей
   - Логирование действий
   - Уведомления

4. **Улучшение безопасности:**
   - JWT токены
   - Rate limiting
   - Валидация на уровне базы данных
